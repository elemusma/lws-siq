!function(t){(sdtdl={...sdtdl,init_sortable_list:function(){t("#sdtdl-list").sortable({containment:"document",items:"> li.sdtdl-item",handle:".dashicons-sort",connectWith:"#sdtdl-list",opacity:.5,update:function(){sdtdl.save_order()}}),t("#sdtdl-affected-list").sortable({containment:"document",items:"> li.sdtdl-item",handle:".dashicons-sort",connectWith:"#sdtdl-affected-list",opacity:.5,update:function(){sdtdl.save_order("affected")}})},save_settings:function(){let e={front:t("#option-show-front").is(":checked"),side:t("#option-front-side").find(":selected").val(),accent:t("#option-accent").val()};t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_save_settings",settings:e,nonce:sdtdl.strings.nonce},dataType:"json",success:function(){!1===e.front?t(".show-front-option"):t(".show-front-option").show()}})},save_order:function(e="own"){let d="sdtdl-list";"affected"===e&&(d="sdtdl-affected-list");let i=t("#"+d+" li.sdtdl-item"),s=[];i.each(function(e,d){let i=t(d);s[e]={front:i.data("front"),id:i.data("id")}}),t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_update_order",data:s,list:e,nonce:sdtdl.strings.nonce},dataType:"json"})},init_dialogs:function(){t(".sdtdl-dialog-content").dialog({autoOpen:!1,position:{my:"center",at:"center",of:"#sdtdl-list"},modal:!0,closeText:sdtdl.strings.Close})},open_dialog:function(e,d=""){let i={},s={},l=".sdtdl-"+e+"-item";switch(e){case"settings":l=".sdtdl-settings",i=[],s={"ui-dialog":"sdtdl-dialog sdtdl-settings-dialog sdtdl-accent-background sdtdl-accent-border"};break;case"affected":i=[{text:sdtdl.strings.MarkComplete,click:function(){sdtdl.previousDialog=this,sdtdl.open_dialog("confirm-complete"),t(this).dialog("close")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-view sdtdl-accent-background sdtdl-accent-border"};break;case"confirm-complete":i=[{text:sdtdl.strings.MarkComplete,click:function(){sdtdl.mark_task_complete(this)}},{text:sdtdl.strings.Cancel,click:function(){t(this).dialog("close"),t(sdtdl.previousDialog).dialog("open")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-delete sdtdl-accent-background sdtdl-accent-border"};break;case"new":i=[{text:sdtdl.strings.Save,click:function(){sdtdl.add_item(this)}}],s={"ui-dialog":"sdtdl-dialog sdtdl-add sdtdl-accent-background sdtdl-accent-border"};break;case"edit":i=[{text:sdtdl.strings.SaveEdits,click:function(){sdtdl.save_edits(this)}}],s={"ui-dialog":"sdtdl-dialog sdtdl-edit sdtdl-accent-background sdtdl-accent-border"},t(l).dialog({open:function(){sdtdl.populate_edit_dialog()}});break;case"delete":i=[{text:sdtdl.strings.Delete,click:function(){sdtdl.delete_item(this)}},{text:sdtdl.strings.Cancel,click:function(){t(this).dialog("close"),t(sdtdl.previousDialog).dialog("open")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-delete sdtdl-accent-background sdtdl-accent-border"};break;default:i=[{text:sdtdl.strings.Edit,click:function(){sdtdl.open_dialog("edit"),t(this).dialog("close")}},{text:sdtdl.strings.Delete,click:function(){sdtdl.previousDialog=this,sdtdl.open_dialog("delete"),t(this).dialog("close")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-view sdtdl-accent-background sdtdl-accent-border"}}"complete"===d?(i={},s["ui-dialog"]+=" sdtdl-complete"):"affected"===d?s["ui-dialog"]+=" sdtdl-affected":"editable"===d&&i.push({text:sdtdl.strings.Edit,click:function(){sdtdl.open_dialog("edit","affected"),t(this).dialog("close")}}),t(l).dialog("option",{buttons:i,classes:s}),t(l).dialog("open")},mark_task_complete:function(e){t(e).dialog("close");let d=t("#sdtdl-affected-list .sdtdl-item[data-key='"+sdtdl.itemIndex+"']");t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_mark_complete",id:d.data("id"),timestamp:Math.floor(Date.now()/1e3),nonce:sdtdl.strings.nonce},dataType:"json",success:function(t){d.addClass("complete"),!0===t.data&&d.fadeOut(500,function(){d.remove()})}})},save_edits:function(e){let d="sdtdl-list";!0===sdtdl.isAffected&&(d="sdtdl-affected-list ");let i=t("#"+d+" .sdtdl-item[data-key='"+sdtdl.itemIndex+"']"),s=t("#edit-sdtdl-text").val(),l=t("#edit-sdtdl-title"),n=l.val(),a=i.find(".sdtdl-item-title").html(),o=i.find(".sdtdl-content-text").html(),c=document.createElement("textarea");c.innerHTML=o,o=c.value,c.remove();let f=o.trim()!==s.trim()||n.trim()!==a.trim(),r=t("#edit-show-front"),u={},m=[];if(!n.length){l.addClass("error");return}let g=Math.floor(Date.now()/1e3);l.removeClass("error"),t(".sdtdl-edit-item input:checkbox[name=users]:checked").each(function(){let e=t(this).attr("id"),d=t(this).val();m.push(d),u[d]=t("label[for="+e+"]").text().trim()});let p=r.is(":checked"),h=Number(t("#sdtdl-edit-allow-edition").is(":checked"));sdtdl.isAffected&&(h=i.data("edit-allowed"));let v={content:{changed:f,title:n,content:s,last_edited:g,id:i.data("id"),affected:{to:"{"+m.join("},{")+"}",edition_allowed:h}},options:{front:p}};t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_edit_item",data:v,date_data:{timestamp:g},nonce:sdtdl.strings.nonce},dataType:"json",success:function(t){if(i.data("front",p),i.data("edit-allowed",h),t.data){if(i.data("edited",g),i.find(".sdtdl-item-title").html(n),i.find(".sdtdl-content-text").html(s),m.length>0){let e=i.data("completed-by"),d="";e=e?e.toString().split(","):[],Object.entries(u).forEach(function([t,i]){let s=!1;e.includes(t)&&(s=!0),d+=sdtdl.create_affected_to_view_element(i,s)}),i.find(".sdtdl-affected-task-info ul").html(d)}sdtdl.adjust_affectation_data(i,m),f&&i.find(".sdtdl-date-edited").html(t.data.time.full)}}}),t(e).dialog("close")},adjust_affectation_data:function(t,e){t.data("affected-to",e.join(","));let d=t.data("completed-by"),i=[];(d=d?d.toString().split(","):[]).forEach(function(t){e.includes(t)&&i.push(t)}),t.data("completed-by",i.join(",")),e.length>0?(t.addClass("affected"),i.length===e.length?t.addClass("complete").removeClass("pending"):t.addClass("pending").removeClass("complete")):t.removeClass("affected complete pending")},populate_view_dialog:function(e){let d=t(e),i="sdtdl-view-item",s=d.find(".sdtdl-item-title").html().trim(),l=d.find(".sdtdl-content-text").html().trim();!0===sdtdl.isAffected&&(i="sdtdl-affected-item");let n=t("."+i+" .sdtdl-content-text"),a=d.find(".sdtdl-dates").html().trim();if(t("."+i+" .sdtdl-dates").html(a),!0===sdtdl.isAffected){let o=d.find(".sdtdl-affected-task-info").html().trim();o=o.replace("%s",d.data("affected-by-name")),t("."+i+" .sdtdl-affected-task-info").html(o)}else{let c=d.find(".sdtdl-affected-task-info").html().trim();t("."+i+" .sdtdl-affected-task-info").html(c)}t("."+i).closest(".ui-dialog").find(".ui-dialog-title").html(s),t("."+i+" .sdtdl-no-content").remove(),l=l.replace(/(?:<(ul|ol)>.*?<\/\1>|<\/li>)\s*?(?=<\/\1>|<li>)/gis,""),n.html(l),0===l.length&&n.after(t(".sdtdl-no-content-container").html())},populate_edit_dialog:function(){let e="sdtdl-list";!0===sdtdl.isAffected&&(e="sdtdl-affected-list ");let d=t("#"+e+" .sdtdl-item[data-key='"+sdtdl.itemIndex+"']"),i=d.find(".sdtdl-item-title").html().trim(),s=d.data("front"),l=d.data("affected-to"),n=Boolean(d.data("edit-allowed")),a=t(".sdtdl-edit-item .sdtdl-affect-user"),o=document.createElement("textarea");l?(l=l.toString().split(","),t(".sdtdl-allow-edition").show()):(l=[],t(".sdtdl-allow-edition").hide()),o.innerHTML=d.find(".sdtdl-content-text").html().trim();let c=t("#edit-sdtdl-title");c.val(i),c.attr("disabled",sdtdl.isAffected),t("#edit-sdtdl-text").val(o.value),o.remove(),t("#edit-show-front").prop("checked",s),t("#sdtdl-edit-allow-edition").prop("checked",n),a.prop("checked",!1),a.each(function(e,d){let i=t(d);l.includes(i.attr("value"))&&i.prop("checked",!0)})},add_item:function(e){let d=t("#new-sdtdl-title"),i=d.val(),s=t("#new-show-front");if(!i){d.addClass("error");return}d.removeClass("error");let l=t("#sdtdl-list"),n=t("#new-sdtdl-text"),a=Math.floor(Date.now()/1e3),o=s.is(":checked"),c=sdtdl.create_li_item(i,n.val(),o,a),f=t(".sdtdl-new-item .sdtdl-affect-user"),r=t("#sdtdl-new-allow-edition"),u=[],m=[];f.each(function(e,d){t(d).is(":checked")&&(u.push(t(d).closest("label").text().trim()),m.push(t(d).val()))}),s.prop("checked",!0),d.val(""),n.val(""),f.prop("checked",!1);let g={content:{title:(c=t(c)).find(".sdtdl-item-title").text().trim(),content:c.find(".sdtdl-content-text")[0].innerHTML.trim(),added:c.data("added"),id:c.data("id"),affected:{to:"{"+m.join("},{")+"}",edition_allowed:Number(r.is(":checked"))}},options:{front:o}};r.prop("checked",!1),t(".sdtdl-allow-edition").hide(),t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_add_item",data:g,date_data:{timestamp:a},nonce:sdtdl.strings.nonce},dataType:"json",success:function(t){if(l.append(c),l.sortable("refresh"),c.find(".sdtdl-date-added").html(t.data.time.full),c.find(".sdtdl-item-title").attr("title",t.data.time.short),m.length){c.data("affected-to",m.join(","));let e="";u.forEach(function(t){e+=sdtdl.create_affected_to_view_element(t,!1)}),c.find(".sdtdl-affected-task-info ul").html(e),c.addClass("affected pending")}sdtdl.count++}}),t(e).dialog("close")},create_affected_to_view_element:function(t,e){let d="clock";return!0===e&&(d="yes"),'<li><span class="dashicons dashicons-'+d+'"></span>'+t},create_li_item:function(t,e,d,i){return'<li class="sdtdl-item" data-key="'+sdtdl.count+'" data-added="'+i+'" data-front='+d+" data-id="+sdtdl.unique_id(i)+'><span class="dashicons dashicons-sort" title="'+sdtdl.strings.DragToSort+'"></span><div class="sdtdl-affectation-icons"><span class="dashicons dashicons-migrate in-title" title="'+sdtdl.strings.Affected+'"></span><span class="dashicons dashicons-clock" title="'+sdtdl.strings.Pending+'"></span><span class="dashicons dashicons-yes" title="'+sdtdl.strings.Completed+'"></span></div><div class="sdtdl-item-title" title="'+sdtdl.strings.RecentlyAdded+'">'+t+'</div><div class="sdtdl-content-container"><div class="sdtdl-content-text">'+e+'</div><div class="sdtdl-dates"><div class="sdtdl-date-added"><span class="dashicons dashicons-plus"></span>'+sdtdl.strings.RecentlyAdded+'</div><div class="sdtdl-date-edited"></div></div><div class="sdtdl-affected-task-info"><span class="dashicons dashicons-migrate"></span>'+sdtdl.strings.YouAffectedTo+"<ul></ul></div></div></li>"},unique_id:function(t){return Math.trunc(t+1e4*Math.random()).toString(36)+sdtdl.strings.UserID.toString()},delete_item:function(e){let d=t("#sdtdl-list .sdtdl-item[data-key='"+sdtdl.itemIndex+"']");t(e).dialog("close"),t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_delete_item",item:d.data("id"),nonce:sdtdl.strings.nonce},dataType:"json",success:function(){d.fadeOut(500,function(){d.remove()})}})},set_accent:function(t){document.documentElement.style.setProperty("--sdtdl-color",t),document.documentElement.style.setProperty("--sdtdl-bg-color",t+"85")},init:function(){t(document).on("click","#sdtdl-list .sdtdl-item",function(e){if(e.target.classList.contains("dashicons"))return!1;sdtdl.isAffected=!1,sdtdl.itemIndex=t(this).data("key");let d="";t(e.target).closest("li").hasClass("affected")&&(d="affected"),sdtdl.populate_view_dialog(this),sdtdl.open_dialog("view",d)}).on("click","#sdtdl-affected-list .sdtdl-item",function(e){if(e.target.classList.contains("dashicons"))return!1;sdtdl.isAffected=!0;let d="",i=t(e.target).closest("li");i.hasClass("complete")?d="complete":1===i.data("edit-allowed")&&(d="editable"),sdtdl.itemIndex=t(this).data("key"),sdtdl.populate_view_dialog(this),sdtdl.open_dialog("affected",d)}).on("click",".sdtdl-add-button",function(){sdtdl.open_dialog("new")}).on("click",".sdtdl-settings-button",function(){sdtdl.open_dialog("settings")}).on("click",".ui-widget-overlay",function(){t(this).siblings(".ui-dialog").find(".ui-dialog-content").dialog("close")}),t(function(){sdtdl.init_dialogs(),sdtdl.init_sortable_list(),t(".sdtdl-list").css("visibility","visible"),sdtdl.count=t("#sdtdl-list .sdtdl-item").length}),t(document).on("change","#option-show-front",function(){this.checked?t(".sdtdl-cond-show-front").fadeIn(200):t(".sdtdl-cond-show-front").fadeOut(200),sdtdl.save_settings()}),t(document).on("change","#option-front-side",function(){sdtdl.save_settings()}),t(document).on("input","#option-accent",function(){sdtdl.set_accent(this.value)}),t(document).on("change","#option-accent",function(){sdtdl.save_settings()}),t(document).on("change",".sdtdl-affect-user",function(){t(this).closest(".sdtdl-dialog-content").find(".sdtdl-affect-user:checked").length?t(".sdtdl-allow-edition").fadeIn(200):t(".sdtdl-allow-edition").fadeOut(200)})}}).init()}(jQuery);