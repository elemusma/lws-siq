!function(t){(sdtdl={...sdtdl,init_sortable_list:function(){t("#sdtdl-list").sortable({containment:"document",items:"> li.sdtdl-item",handle:".dashicons-sort",connectWith:"#sdtdl-list",opacity:.5,update:function(){sdtdl.save_order()}}),t("#sdtdl-affected-list").sortable({containment:"document",items:"> li.sdtdl-item",handle:".dashicons-sort",connectWith:"#sdtdl-affected-list",opacity:.5,update:function(){sdtdl.save_order("affected")}})},save_settings:function(){let e={front:t("#option-show-front").is(":checked"),side:t("#option-front-side").find(":selected").val(),accent:t("#option-accent").val()};t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_save_settings",settings:e,nonce:sdtdl.strings.nonce},dataType:"json",success:function(){!1===e.front?t(".show-front-option").hide():t(".show-front-option").show()}})},save_order:function(e="own"){let d="sdtdl-list";"affected"===e&&(d="sdtdl-affected-list");let i=t("#"+d+" li.sdtdl-item"),s=[];i.each(function(e,d){let i=t(d);s[e]={front:i.data("front"),id:i.data("id")}}),t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_update_order",data:s,list:e,nonce:sdtdl.strings.nonce},dataType:"json"})},init_dialogs:function(){t(".sdtdl-dialog-content").dialog({autoOpen:!1,position:{my:"center",at:"center",of:"#sdtdl-list"},modal:!0,closeText:sdtdl.strings.Close})},open_dialog:function(e,d=""){let i={},s={},n=".sdtdl-"+e+"-item";switch(e){case"settings":n=".sdtdl-settings",i=[],s={"ui-dialog":"sdtdl-dialog sdtdl-settings-dialog sdtdl-accent-background sdtdl-accent-border"};break;case"affected":i=[{text:sdtdl.strings.MarkComplete,click:function(){sdtdl.previousDialog=this,sdtdl.open_dialog("confirm-complete"),t(this).dialog("close")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-view sdtdl-accent-background sdtdl-accent-border"};break;case"confirm-complete":i=[{text:sdtdl.strings.MarkComplete,click:function(){sdtdl.mark_task_complete(this)}},{text:sdtdl.strings.Cancel,click:function(){t(this).dialog("close"),t(sdtdl.previousDialog).dialog("open")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-delete sdtdl-accent-background sdtdl-accent-border"};break;case"new":i=[{text:sdtdl.strings.Save,click:function(){sdtdl.add_item(this)}}],s={"ui-dialog":"sdtdl-dialog sdtdl-add sdtdl-accent-background sdtdl-accent-border"};break;case"edit":i=[{text:sdtdl.strings.SaveEdits,click:function(){sdtdl.save_edits(this)}}],s={"ui-dialog":"sdtdl-dialog sdtdl-edit sdtdl-accent-background sdtdl-accent-border"},t(n).dialog({open:function(){sdtdl.populate_edit_dialog()}});break;case"delete":i=[{text:sdtdl.strings.Delete,click:function(){sdtdl.delete_item(this)}},{text:sdtdl.strings.Cancel,click:function(){t(this).dialog("close"),t(sdtdl.previousDialog).dialog("open")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-delete sdtdl-accent-background sdtdl-accent-border"};break;default:i=[{text:sdtdl.strings.Edit,click:function(){sdtdl.open_dialog("edit"),t(this).dialog("close")}},{text:sdtdl.strings.Delete,click:function(){sdtdl.previousDialog=this,sdtdl.open_dialog("delete"),t(this).dialog("close")}}],s={"ui-dialog":"sdtdl-dialog sdtdl-view sdtdl-accent-background sdtdl-accent-border"}}"complete"===d?(i={},s["ui-dialog"]+=" sdtdl-complete"):"affected"===d&&(s["ui-dialog"]+=" sdtdl-affected"),t(n).dialog("option",{buttons:i,classes:s}),t(n).dialog("open")},mark_task_complete:function(e){t(e).dialog("close");let d=t("#sdtdl-affected-list .sdtdl-item[data-key='"+sdtdl.item_index+"']");t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_mark_complete",id:d.data("id"),timestamp:Math.floor(Date.now()/1e3),nonce:sdtdl.strings.nonce},dataType:"json",success:function(t){d.addClass("complete"),!0===t.data&&d.fadeOut(500,function(){d.remove()})}})},save_edits:function(e){let d=t("#sdtdl-list .sdtdl-item[data-key='"+sdtdl.item_index+"']"),i=t("#edit-sdtdl-text").val(),s=t("#edit-sdtdl-title"),n=s.val(),a=d.find(".sdtdl-item-title").html(),l=d.find(".sdtdl-content-text").html(),o=document.createElement("textarea");o.innerHTML=l,l=o.value,o.remove();let c=l.trim()!==i.trim()||n.trim()!==a.trim(),r=t("#edit-show-front"),f={},u=[];if(!n.length){s.addClass("error");return}let m=Math.floor(Date.now()/1e3);s.removeClass("error"),t(".sdtdl-edit-item input:checkbox[name=users]:checked").each(function(){let e=t(this).attr("id"),d=t(this).val();u.push(d),f[d]=t("label[for="+e+"]").text().trim()});let g=r.is(":checked"),p={content:{changed:c,title:n,content:i,last_edited:m,id:d.data("id"),affected:{by:sdtdl.strings.UserID,to:"{"+u.join("},{")+"}"}},options:{front:g}};t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_edit_item",data:p,date_data:{timestamp:m},nonce:sdtdl.strings.nonce},dataType:"json",success:function(t){if(d.data("front",g),t.data){if(d.data("edited",m),d.find(".sdtdl-item-title").html(n),d.find(".sdtdl-content-text").html(i),u.length>0){let e=d.data("completed-by"),s="";e=e?e.toString().split(","):[],Object.entries(f).forEach(function([t,d]){let i=!1;e.includes(t)&&(i=!0),s+=sdtdl.create_affected_to_view_element(d,i)}),d.find(".sdtdl-affected-task-info ul").html(s)}sdtdl.adjust_affectation_data(d,u),c&&d.find(".sdtdl-date-edited").html(t.data.time.full)}}}),t(e).dialog("close")},adjust_affectation_data:function(t,e){t.data("affected-to",e.join(","));let d=t.data("completed-by"),i=[];(d=d?d.toString().split(","):[]).forEach(function(t){e.includes(t)&&i.push(t)}),t.data("completed-by",i.join(",")),e.length>0?(t.addClass("affected"),i.length===e.length?t.addClass("complete").removeClass("pending"):t.addClass("pending").removeClass("complete")):t.removeClass("affected complete pending")},populate_view_dialog:function(e,d="own"){let i=t(e),s="sdtdl-view-item",n=i.find(".sdtdl-item-title").html().trim(),a=i.find(".sdtdl-content-text").html().trim();"affected"===d&&(s="sdtdl-affected-item");let l=t("."+s+" .sdtdl-content-text");if("own"===d){let o=i.find(".sdtdl-dates").html().trim(),c=i.find(".sdtdl-affected-task-info").html().trim();t("."+s+" .sdtdl-dates").html(o),t("."+s+" .sdtdl-affected-task-info").html(c)}else{let r=i.find(".sdtdl-affected-task-info").html().trim();r=r.replace("%s",i.data("affected-by-name")),t("."+s+" .sdtdl-affected-task-info").html(r)}t("."+s).closest(".ui-dialog").find(".ui-dialog-title").html(n),t("."+s+" .sdtdl-no-content").remove(),a=a.replace(/(?:<(ul|ol)>.*?<\/\1>|<\/li>)\s*?(?=<\/\1>|<li>)/gis,""),l.html(a),0===a.length&&l.after(t(".sdtdl-no-content-container").html())},populate_edit_dialog:function(){let e=t("#sdtdl-list .sdtdl-item[data-key='"+sdtdl.item_index+"']"),d=e.find(".sdtdl-item-title").html().trim(),i=e.data("front"),s=e.data("affected-to"),n=t(".sdtdl-edit-item .sdtdl-affect-user"),a=document.createElement("textarea");s=s?s.toString().split(","):[],a.innerHTML=e.find(".sdtdl-content-text").html().trim(),t("#edit-sdtdl-title").val(d),t("#edit-sdtdl-text").val(a.value),a.remove(),t("#edit-show-front").prop("checked",i),n.prop("checked",!1),n.each(function(e,d){let i=t(d);s.includes(i.attr("value"))&&i.prop("checked",!0)})},add_item:function(e){let d=t("#new-sdtdl-title"),i=d.val(),s=t("#new-show-front");if(!i){d.addClass("error");return}d.removeClass("error");let n=t("#sdtdl-list"),a=t("#new-sdtdl-text"),l=Math.floor(Date.now()/1e3),o=s.is(":checked"),c=sdtdl.create_li_item(i,a.val(),o,l),r=t(".sdtdl-new-item .sdtdl-affect-user"),f=[],u=[];r.each(function(e,d){t(d).is(":checked")&&(f.push(t(d).closest("label").text().trim()),u.push(t(d).val()))}),s.prop("checked",!0),d.val(""),a.val(""),r.prop("checked",!1);let m={content:{title:(c=t(c)).find(".sdtdl-item-title").text().trim(),content:c.find(".sdtdl-content-text")[0].innerHTML.trim(),added:c.data("added"),id:c.data("id"),affected:{by:sdtdl.strings.UserID,to:"{"+u.join("},{")+"}"}},options:{front:o}};t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_add_item",data:m,date_data:{timestamp:l},nonce:sdtdl.strings.nonce},dataType:"json",success:function(t){if(n.append(c),n.sortable("refresh"),c.find(".sdtdl-date-added").html(t.data.time.full),c.find(".sdtdl-item-title").attr("title",t.data.time.short),u.length){c.data("affected-to",u.join(","));let e="";f.forEach(function(t){e+=sdtdl.create_affected_to_view_element(t,!1)}),c.find(".sdtdl-affected-task-info ul").html(e),c.addClass("affected pending")}sdtdl.count++}}),t(e).dialog("close")},create_affected_to_view_element:function(t,e){let d="clock";return!0===e&&(d="yes"),'<li><span class="dashicons dashicons-'+d+'"></span>'+t},create_li_item:function(t,e,d,i){return'<li class="sdtdl-item" data-key="'+sdtdl.count+'" data-added="'+i+'" data-front='+d+" data-id="+sdtdl.unique_id(i)+'><span class="dashicons dashicons-sort" title="'+sdtdl.strings.DragToSort+'"></span><div class="sdtdl-affectation-icons"><span class="dashicons dashicons-migrate in-title" title="'+sdtdl.strings.Affected+'"></span><span class="dashicons dashicons-clock" title="'+sdtdl.strings.Pending+'"></span><span class="dashicons dashicons-yes" title="'+sdtdl.strings.Completed+'"></span></div><div class="sdtdl-item-title" title="'+sdtdl.strings.RecentlyAdded+'">'+t+'</div><div class="sdtdl-content-container"><div class="sdtdl-content-text">'+e+'</div><div class="sdtdl-dates"><div class="sdtdl-date-added"><span class="dashicons dashicons-plus"></span>'+sdtdl.strings.RecentlyAdded+'</div><div class="sdtdl-date-edited"></div></div><div class="sdtdl-affected-task-info"><span class="dashicons dashicons-migrate"></span>'+sdtdl.strings.YouAffectedTo+"<ul></ul></div></div></li>"},unique_id:function(t){return Math.trunc(t+1e4*Math.random()).toString(36)+sdtdl.strings.UserID.toString()},delete_item:function(e){let d=t("#sdtdl-list .sdtdl-item[data-key='"+sdtdl.item_index+"']");t(e).dialog("close"),t.ajax({type:"POST",url:ajaxurl,data:{action:"sdtdl_delete_item",item:d.data("id"),nonce:sdtdl.strings.nonce},dataType:"json",success:function(){d.fadeOut(500,function(){d.remove()})}})},set_accent:function(t){document.documentElement.style.setProperty("--sdtdl-color",t),document.documentElement.style.setProperty("--sdtdl-bg-color",t+"85")},init:function(){t(document).on("click","#sdtdl-list .sdtdl-item",function(e){if(e.target.classList.contains("dashicons"))return!1;sdtdl.item_index=t(this).data("key");let d="";t(e.target).closest("li").hasClass("affected")&&(d="affected"),sdtdl.populate_view_dialog(this),sdtdl.open_dialog("view",d)}).on("click","#sdtdl-affected-list .sdtdl-item",function(e){if(e.target.classList.contains("dashicons"))return!1;let d="";t(e.target).closest("li").hasClass("complete")&&(d="complete"),sdtdl.item_index=t(this).data("key"),sdtdl.populate_view_dialog(this,"affected"),sdtdl.open_dialog("affected",d)}).on("click",".sdtdl-add-button",function(){sdtdl.open_dialog("new")}).on("click",".sdtdl-settings-button",function(){sdtdl.open_dialog("settings")}).on("click",".ui-widget-overlay",function(){t(this).siblings(".ui-dialog").find(".ui-dialog-content").dialog("close")}),t(function(){sdtdl.init_dialogs(),sdtdl.init_sortable_list(),t(".sdtdl-list").css("visibility","visible"),sdtdl.count=t("#sdtdl-list .sdtdl-item").length}),t(document).on("change","#option-show-front",function(){this.checked?t(".sdtdl-cond-show-front").fadeIn(200):t(".sdtdl-cond-show-front").fadeOut(200),sdtdl.save_settings()}),t(document).on("change","#option-front-side",function(){sdtdl.save_settings()}),t(document).on("input","#option-accent",function(){sdtdl.set_accent(this.value)}),t(document).on("change","#option-accent",function(){sdtdl.save_settings()})}}).init()}(jQuery);